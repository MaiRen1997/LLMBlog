## 智能体开发流程

### 初始化工具

```python
class AddInputArgs(BaseModel):
    a: int = Field(description="first number")
    b: int = Field(description="second number")

@tool(
    description="add two numbers",
    args_schema=AddInputArgs,
    return_direct=True,
)
def add(a, b):
    """add two numbers"""
    return a + b

def create_calc_tools():
    return [add]
    
calc_tools = create_calc_tools()
```

### 初始化大模型

```python
llm = ChatOpenAI(
    model="qwen-max-latest",
    base_url="https://dashscope.aliyuncs.com/compatible-mode/v1",
    api_key=SecretStr("sk-xxx"),
    temperature=0,
)
```

### 创建智能体

AgentType类型，具体见后面

```python
agent = initialize_agent(
    tools=calc_tools,
    llm=llm,
    agent=AgentType.STRUCTURED_CHAT_ZERO_SHOT_REACT_DESCRIPTION,
    verbose=True,
)
```

### 调用智能体

```python
messages = chat_prompt.format_messages(
    role="计算",
    domain="使用工具进行数学计算",
    question="100+100=？"
)

resp = agent.invoke(messages)
```

由于打开了verbose调试模式，所以会返回思考过程:

````python
> Entering new AgentExecutor chain...
Thought: 这是一个简单的加法问题，我可以通过使用'add'函数来解决。
Action:
```
{
  "action": "add",
  "action_input": {
    "a": 100,
    "b": 100
  }
}
```
Observation: 200


> Finished chain.
{'input': [ChatMessage(content='你是一位计算专家，擅长回答使用工具进行数学计算领域的问题。', additional_kwargs={}, response_metadata={}, role='system'), ChatMessage(content='用户问题：100+100=？', additional_kwargs={}, response_metadata={}, role='user')], 'output': 200}
````

## 智能体关键知识点

### Agent Type

LangChain提供多种Agent类型，每种类型适用于不同的场景和需求。以下是几种主要Agent类型及其特点：

| **AgentType**                                   | **核心机制**       | **适用场景**       | **优点**               | **缺点**                 |
| ----------------------------------------------- | ------------------ | ------------------ | ---------------------- | ------------------------ |
| **ZERO_SHOT_REACTDESCRIPTION**                  | ReAct + 工具描述   | 简单任务、工具组合 | 快速集成、无需训练数据 | 输出格式自由，可控性较低 |
| **STRUCTURED_CHAT_ZERO_SHOT_REACT_DESCRIPTION** | 结构化输出 + ReAct | 结构化工具调用     | 高可控性、格式严格     | 依赖工具描述清晰度       |
| **OPENAI_FUNCTIONS**                            | OpenAI 函数调用    | OpenAI 模型场景    | 高效、强耦合 OpenAI    | 仅限 OpenAI 模型         |
| **CONVERSATIONAL_REACT_DESCRIPTION**            | 多轮对话 + ReAct   | 多轮交互任务       | 上下文感知、灵活性高   | 需配置记忆模块           |
| **AUTO_GPT**                                    | 自主代理循环       | 复杂任务自动化     | 自主决策、长期目标     | 实验性、稳定性待验证     |
| **STRUCTURED_CHAT**                             | 严格结构化输出     | 数据提取、表单填写 | 格式标准化、可控性强   | 灵活性低                 |

### 返回体结构化

```python
from langchain.agent import initialize_agent, AgentType
from pydantic import BaseModel, Field

from langchain_core.output_parsers import JsonOutputParser

class Output(BaseModel):
    args: str = Field("工具的入参")
    result: str = Field("计算的结果")
    think: str = Field("思考过程")
    
    
parser = JsonOutputParser(pydantic_object = Output) # 通过JsonOutputParser创建格式的实例化对象
format_instructions = parser.get_format_instructions() # 对参数进行格式化

print(format_instructions)

messages = chat_prompt.format_messages(
    role="计算",
    domain="使用工具进行数学计算",
    question=f"""
请阅读下面的问题，并返回一个严格的 JSON 对象，不要使用 Markdown 代码块包裹！
格式要求：
{format_instructions}

问题：
100+100=？
"""
)

resp = agent.invoke(messages)

print(resp["output"])
"""
{
  "result": "200",
  "args": "100, 100"
}
"""
```

注意需要设置`return_direct=False`：

```python
@tool(
    description="add two numbers",
    args_schema=AddInputArgs,
    return_direct=False,
)
def add(a, b):
    """add two numbers"""
    return a + b
```

### LangChain内置工具

Tool使用方法：https://python.langchain.com/docs/integrations/tools/

内置Tooltiks：https://api.python.langchain.com/en/latest/community/agent_toolkits.html

### Python REPL

官网：https://python.langchain.com/docs/integrations/tools/python/

#### 利用Python REPL开发一个企业官网

```python
from langchain.agents import initialize_agent, AgentType
from langchain_core.prompts import PromptTemplate
from langchain_experimental.tools.python.tool import PythonREPLTool

from app.common import llm


tools = [PythonREPLTool()]

tool_names = ["PythonREPLTool"]

agent = initialize_agent(
    tools=tools,
    llm=llm,
    agent=AgentType.ZERO_SHOT_REACT_DESCRIPTION,
    verbose=True,
)

prompt_template = PromptTemplate.from_template(template="""尽你所能回答以下问题，你可以使用以下工具：
{tools}
--
请按照以下格式：
问题：你必须回答的输入问题
思考：你应该始终考虑该怎么做
行动：要采取的行动，应该是[{tool_names}]中的一个
行动输入：行动的输入
观察：行动的结果
... (这个思考/行动/行动输入/观察可以重复N次)
思考：我现在知道最终答案了
最终答案：对原始输入问题的最终答案
--
注意：
- PythonREPLTool工具的入参是python代码，不允许添加 ```python 或 ```py 等标记
--
开始吧！
问题：{input}""")

prompt = prompt_template.format(
    tools=tools,
    tool_names=tool_names,
    input="向/Users/sam/llm/.temp目录下写入一个新文件，名称为：index.html，并写一个企业的官网",
)

print(prompt)

agent.invoke(prompt)
```

回答结果：

```python
> Entering new AgentExecutor chain...
我需要使用Python代码来完成文件的创建和写入操作。
Action: Python_REPL
Action Input: 
with open("/Users/sam/llm/.temp/index.html", "w") as file:
    file.write("""
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Company - Home</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
        }
        header {
            background: #2c3e50;
            color: #fff;
            padding: 10px 20px;
            text-align: center;
        }
        nav {
            background: #34495e;
            color: white;
            display: flex;
            justify-content: center;
            padding: 10px;
        }
        nav a {
            color: white;
            margin: 0 15px;
            text-decoration: none;
        }
        section {
            padding: 20px;
            text-align: center;
        }
        footer {
            background: #2c3e50;
            color: white;
            text-align: center;
            padding: 10px 0;
            position: fixed;
            width: 100%;
            bottom: 0;
        }
    </style>
</head>
<body>
    <header>
        <h1>Welcome to Our Company</h1>
    </header>
    <nav>
        <a href="#home">Home</a>
        <a href="#services">Services</a>
        <a href="#about">About Us</a>
        <a href="#contact">Contact</a>
    </nav>
    <section id="home">
        <h2>Your Success is Our Mission</h2>
        <p>We provide cutting-edge solutions tailored to your needs.</p>
    </section>
    <footer>
        &copy; 2023 Our Company. All rights reserved.
    </footer>
</body>
</html>
    """)
Python REPL can execute arbitrary code. Use with caution.
Observation: 
Thought:我现在知道最终答案了。
Final Answer: 已成功在目录 `/Users/sam/llm/.temp` 下创建了一个名为 `index.html` 的文件，并写入了一个企业官网的HTML代码。该页面包含一个欢迎标题、导航栏、主页内容以及页脚信息，展示了基本的企业官网结构。

> Finished chain.
```

### LangChain output_parsers库

























